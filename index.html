<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatorio de Diferencas</title>
  <style>
:root{
  --green:#00ff66; --panel: rgba(0,0,0,0.6); --text:#eaeaea; --border:#1aff7a;
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;color:var(--text);
  background:
    linear-gradient(180deg,#080808 0%, #0f0f0f 40%, #161616 100%),
    url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"28\" height=\"28\"><defs><pattern id=\"c\" patternUnits=\"userSpaceOnUse\" width=\"28\" height=\"28\" patternTransform=\"skewX(-20)\"><rect width=\"28\" height=\"28\" fill=\"%23111111\"/><path d=\"M0 14 h28\" stroke=\"%23262626\" stroke-width=\"6\"/></pattern></defs><rect width=\"100%\" height=\"100%\" fill=\"url(%23c)\"/></svg>');
  background-blend-mode: overlay;}
header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:2px solid var(--border);
  background:linear-gradient(180deg,#0e0e0e,#0b0b0b);position:sticky;top:0;z-index:10}
header h1{margin:0;font-weight:800;letter-spacing:.5px}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;margin-left:8px;color:var(--green)}
.container{max-width:980px;margin:0 auto;padding:20px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.35)}
input,select,textarea,button{border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.35);color:var(--text);padding:10px 12px}
input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 3px rgba(0,255,102,.2)}
button{cursor:pointer;font-weight:700;transition:.25s;background:linear-gradient(180deg,#0f0f0f,#141414);color:#00ff66}
button:hover{filter:brightness(1.2)}
.row{display:flex;gap:10px;flex-wrap:wrap}.row > *{flex:1 1 220px}
.report{border:1px solid var(--border);border-radius:14px;padding:12px;background:rgba(0,0,0,.5);margin:10px 0}
.report .head{display:flex;align-items:center;gap:8px;justify-content:space-between}
.report .meta{opacity:.9;font-size:.95rem}.hidden{display:none}
.alert{color:#ff4d4d;font-weight:800;margin-left:8px}
hr{border:none;border-top:1px solid #2a2a2a;margin:16px 0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999}
.popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:min(680px,92vw);max-height:85vh;overflow:auto;background:#121212;border:2px solid var(--border);border-radius:16px;padding:16px;z-index:10000;text-align:center}
.popup h3{margin-top:0}
.thumb{display:flex;align-items:center;gap:8px;margin:6px 0}
.thumb img{width:84px;height:64px;object-fit:cover;border:1px solid var(--border);border-radius:8px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, \"Liberation Mono\", monospace;font-size:.85rem;padding:0 6px;border:1px solid #2f2f2f;border-radius:6px;background:#0e0e0e}
.chip{display:inline-block;padding:4px 10px;border:1px solid var(--border);border-radius:999px;margin:4px 6px 0 0}.group{cursor:pointer}.group:hover{filter:brightness(1.15)}
.small{font-size:.9rem;opacity:.9}

/* ===== Tema Cromado e Carbono ===== */

body {
    background: radial-gradient(circle at center, #2c2c2c, #1a1a1a);
    background-attachment: fixed;
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

input, textarea, select {
    background: linear-gradient(145deg, #d4d4d4, #f5f5f5);
    border: 2px solid #c0c0c0;
    border-radius: 6px;
    box-shadow: inset -2px -2px 5px rgba(255,255,255,0.6),
                inset 2px 2px 5px rgba(0,0,0,0.3);
    
    padding: 8px;
    font-weight: bold;
}

button {
    background: linear-gradient(145deg, #f0f0f0, #b0b0b0);
    border: 2px solid #999;
    border-radius: 8px;
    color: #111;
    font-weight: bold;
    padding: 10px 20px;
    box-shadow: -3px -3px 6px rgba(255,255,255,0.6),
                3px 3px 6px rgba(0,0,0,0.3);
    transition: all 0.2s ease-in-out;
}

button:hover {
    background: linear-gradient(145deg, #ffffff, #c0c0c0);
    transform: scale(1.05);
}

h1, h2, h3, label {
    background: linear-gradient(to right, #f0f0f0, #a0a0a0, #f0f0f0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

#pos-conferencia, .pos-conferencia { color: #fff !important; }

.pos-conferencia ::placeholder,
#pos-conferencia ::placeholder {
    color: #fff !important;
    opacity: 1; /* Para garantir que fique totalmente visível */
}

#posObsField {
    color: #fff !important;
    background-color: #333 !important;
}
#posObsField::placeholder {
    color: #fff !important;
    opacity: 1;
}

/* Força cor branca no campo de Pós Conferência, inclusive em WebKit/Chromium */
#posObsField,





/* Forçar branco em campos dentro de popups e no campo de pós conferência */



/* Cor branca apenas para o campo Obs pós conferência */
#posObsField {
  color:#fff !important;
  -webkit-text-fill-color:#fff !important;
  caret-color:#fff !important;
}


/* Texto branco apenas no campo Pós conferência */
#posObsField {
    color: #fff !important;
    -webkit-text-fill-color: #fff !important;
    background-color: #333;
    caret-color: #fff;
}


/* Reset para todos os campos editáveis exceto Pós conferência */
input, textarea, select {
    color: #000 !important;
    -webkit-text-fill-color: #000 !important;
}

/* Texto branco apenas no campo Pós conferência */
#posObsField {
    color: #fff !important;
    -webkit-text-fill-color: #fff !important;
    background-color: #333;
    caret-color: #fff;
}


/* --- RESET DE CORES PARA CAMPOS EDITAVEIS (GLOBAL) --- */
input, textarea, select {
  color: #000 !important;
  -webkit-text-fill-color: #000 !important;
  caret-color: #000 !important;
}

/* --- APENAS o campo do popup "Pos conferencia" deve ser branco --- */
#posObsField {
  color: #fff !important;
  -webkit-text-fill-color: #fff !important;
  caret-color: #fff !important;
  background-color: #333 !important;
}

/* === CAMPOS EDITÁVEIS CINZA ESCURO + TEXTO BRANCO === */
input, textarea, select {
  background-color: #2b2b2b !important;
  color: #fff !important;
  -webkit-text-fill-color: #fff !important;
  caret-color: #fff !important;
}
input::placeholder, textarea::placeholder, select::placeholder {
  color: #aaa !important;
  opacity: 1;
}

</style>
</head>
<body>
  <div id="app"></div>
  
<!-- JS embutido para compatibilidade com GitHub Pages -->
<script>
console.log("DEBUG: script.js iniciou execução");
const app = document.getElementById('app');
let currentUser = null;
let reports = JSON.parse(localStorage.getItem('reports_v8') || '[]');
let users = JSON.parse(localStorage.getItem('users_v6') || '[]');
const admins = ["0001","admin","6266","70029","4144"];
let adminViewMatricula = null;
const brl = (n)=>`R$ ${Number(n||0).toFixed(2)}`;
const saveReports = ()=>localStorage.setItem('reports_v8', JSON.stringify(reports));
const saveUsers   = ()=>localStorage.setItem('users_v6', JSON.stringify(users));
const byDateDesc = (a,b)=> (a.data>b.data?-1:a.data<b.data?1:0);

// Screens
console.log("DEBUG: Entrando na função function renderLogin(");function renderLogin(){
  app.innerHTML = `<header><h1>Relatório de Diferenças</h1></header>
  <div class="container"><div class="card">
    <div class="row"><input id="matricula" placeholder="Matrícula"><input id="senha" type="password" placeholder="Senha"></div>
    <div class="row"><button onclick="login()">Login</button><button onclick="renderRegister()">Cadastrar novo usuário</button></div>
  </div></div>`;
}
console.log("DEBUG: Entrando na função function renderRegister(");function renderRegister(){
  app.innerHTML = `<header><h1>Cadastrar Usuário</h1></header>
  <div class="container"><div class="card">
    <div class="row"><input id="matricula" placeholder="Matrícula"><input id="nome" placeholder="Nome"><input id="senha" type="password" placeholder="Senha"></div>
    <div class="row"><button onclick="register()">Cadastrar</button><button onclick="renderLogin()">Voltar</button></div>
  </div></div>`;
}

// Auth
console.log("DEBUG: Entrando na função function register(");function register(){
  const m = document.getElementById('matricula').value.trim();
  const n = document.getElementById('nome').value.trim();
  const s = document.getElementById('senha').value.trim();
  if(!m||!n||!s) return alert("Preencha todos os campos.");
  if(users.find(u=>u.matricula===m)) return alert("Matrícula já cadastrada.");
  users.push({matricula:m,nome:n,senha:s});
  saveUsers(); alert("Usuário cadastrado!"); renderLogin();
}
console.log("DEBUG: Entrando na função function login(");function login(){
  const m = document.getElementById('matricula').value.trim();
  const s = document.getElementById('senha').value.trim();
  const user = users.find(u=>u.matricula===m && u.senha===s);
  if(!user) return alert("Credenciais inválidas.");
  currentUser = user;
  renderMain();
}
console.log("DEBUG: Entrando na função function logout(");function logout(){ currentUser=null; renderLogin(); }
console.log("DEBUG: Entrando na função function changePassword(");function changePassword(){
  const nova = prompt("Digite a nova senha:");
  if(!nova) return;
  users = users.map(u=>u.matricula===currentUser.matricula? {...u,senha:nova}:u);
  saveUsers(); alert("Senha alterada!");
}

// Pós conferência
console.log("DEBUG: Entrando na função function openObsPopup(");function openObsPopup(idx){
  const isAdmin = admins.includes(currentUser.matricula);
  const overlay = document.createElement('div'); overlay.className='overlay'; overlay.id='overlayObs';
  const popup   = document.createElement('div'); popup.className='popup'; popup.id='popupObs';

  const r = reports[idx];
  const thumbs = (r.posObs.images||[]).map((src, j)=>`
    <div class="thumb">
      <img src="${src}" alt="thumb">
      <div class="actions">
        <button onclick="window.open('${src}','_blank')">Visualizar</button>
        ${isAdmin? `<button onclick="deleteObsImage(${idx},${j})">Excluir</button>`:""}
      </div>
    </div>`).join("");

  
  // (reconstruido) conteúdo do popup de Pós conferência
  r.posObs = r.posObs || { images: [], text: "" };
  
  // conteúdo reconstruido do popup de Pos conferencia (seguro)
  r.posObs = r.posObs || { images: [], text: "" };
  const adminInputRow = isAdmin ? '<div class="row"><input id="imgInput" type="file" accept="image/*" multiple></div>' : '';
  const adminActions = isAdmin 
    ? '<button onclick="saveObs(' + idx + ')">Salvar</button><button onclick="addObsImages(' + idx + ')">Adicionar Imagens</button>' 
    : '';
  popup.innerHTML = `
    <div class="popup-header">
      <h3>Obs pos conferencia</h3>
      <button class="close" onclick="closeObsPopup()">×</button>
    </div>
    <div class="popup-body">
      <div class="row">
        <textarea id="posObsField" ${isAdmin ? "" : "readonly"}>${r.posObs.text || ""}</textarea>
      </div>
      ${adminInputRow}
      <div class="thumbs">${thumbs || ''}</div>
    </div>
    <div class="popup-actions">
      ${adminActions}
      <button onclick="closeObsPopup()">Fechar</button>
    </div>


  // força cor branca no campo de pós-conferência
  setTimeout(() => {
    const f = document.getElementById('posObsField');
    if (f) {
      f.style.color = '#fff';
      f.style.backgroundColor = '#333';
      f.style.caretColor = '#fff';
      try { f.style.webkitTextFillColor = '#fff'; } catch(e) {}
    }
  }, 0);


  document.body.appendChild(overlay); document.body.appendChild(popup);
}
console.log("DEBUG: Entrando na função function closeObsPopup(");function closeObsPopup(){ document.getElementById('overlayObs')?.remove(); document.getElementById('popupObs')?.remove(); }
console.log("DEBUG: Entrando na função function addObsImages(");function addObsImages(idx){
  const input = document.getElementById('imgInput');
  if(!input || !input.files?.length) return;
  const r = reports[idx];
  r.posObs.images = r.posObs.images || [];
  const files = Array.from(input.files);
  let pending = files.length;
  files.forEach(file=>{
    const reader = new FileReader();
    reader.onload = e=>{
      r.posObs.images.push(e.target.result);
      if(--pending===0){ saveReports();
        closeObsPopup(); openObsPopup(idx); renderMain();
      }};
    reader.readAsDataURL(file);
  });
}
console.log("DEBUG: Entrando na função function deleteObsImage(");function deleteObsImage(idx, j){
  const r = reports[idx]; if(!r.posObs?.images) return;
  r.posObs.images.splice(j,1);
  saveReports(); closeObsPopup(); openObsPopup(idx); renderMain();
}
console.log("DEBUG: Entrando na função function saveObs(");function saveObs(idx){
  const r = reports[idx];
  r.posObs.text = document.getElementById('posObsField').value;
  saveReports(); alert('Pós conferência salva!'); renderMain();
}

// CRUD
console.log("DEBUG: Entrando na função function addReport(");function addReport(){
  const data = document.getElementById('data').value;
  const folha = parseFloat(document.getElementById('folha').value);
  const dinheiro = parseFloat(document.getElementById('dinheiro').value);
  if(isNaN(folha)||isNaN(dinheiro) || !data) return alert("Preencha data e valores numéricos.");
  const obs = document.getElementById('obs').value;
  const sf = (dinheiro - folha).toFixed(2);
  const matricula = document.getElementById('userSelect') ? document.getElementById('userSelect').value : currentUser.matricula;
  reports.push({data, folha, dinheiro, sf, obs, matricula, posObs:{text:"", images:[]}});
  saveReports(); renderMain();
}
console.log("DEBUG: Entrando na função function deleteReport(");function deleteReport(i){
  if(!confirm("Excluir este relatório?")) return;
  reports.splice(i,1); saveReports(); renderMain();
}
console.log("DEBUG: Entrando na função function toggleReport(");function toggleReport(i){ document.getElementById('report-'+i)?.classList.toggle('hidden'); }

// List
console.log("DEBUG: Entrando na função function renderMain(");function renderMain(){
  const isAdmin = admins.includes(currentUser.matricula);
  let top = `<header><h1>Relatório de Diferenças <span class="badge">${isAdmin?'Admin':'Usuário'}</span></h1>
    <div><span class="small">${currentUser.nome} (${currentUser.matricula})</span>
    <button onclick="changePassword()">Alterar Senha</button><button onclick="logout()">Logout</button></div></header>`;
  let content = `<div class="container">`;

  if(isAdmin){
    if(!adminViewMatricula){
      const matsSet = new Set(reports.map(r=>r.matricula));
      const mats = Array.from(matsSet).sort();
      const userOptions = users.map(u=>`<option value="${u.matricula}">${u.matricula} - ${u.nome}</option>`).join('');
      content += `
        <div class="card">
          <h3>Gerar Relatório</h3>
          <div class="row">
            <select id="userSelect">${userOptions}</select>
            <input id="data" type="date">
            <input id="folha" type="number" step="0.01" placeholder="Valor folha (R$)">
            <input id="dinheiro" type="number" step="0.01" placeholder="Valor em dinheiro (R$)">
            <input id="obs" placeholder="Observação">
          </div>
          <div class="row"><button onclick="addReport()">Salvar</button></div>
        </div>
        <div class="card">
          <h3>Matrículas</h3>
          ${(mats.length? mats.map(m=>`<button class="chip group" onclick="openAdminMat('${m}')">${m}</button>`).join('') : '<span class="small">Sem relatórios.</span>')}
          <p class="small">Clique numa matrícula para ver os caixas.</p>
        </div>`;
    } else {
      const all = reports.filter(r=>r.matricula===adminViewMatricula).sort(byDateDesc);
      const latest = all.slice(0,20);
      content += `
        <div class="card">
          <div class="row">
            <button onclick="adminViewMatricula=null; renderMain()">← Voltar</button>
            <div class="badge">Matrícula ${adminViewMatricula}</div>
          </div>
          <h3>Últimos 20 relatórios</h3>
          ${renderReports(latest, true)}
          <hr/>
          <div class="row"><input type="date" id="filterDateAdmin"><button onclick="filterOlderAdmin()">Filtrar mais antigos</button></div>
          <div id="olderAdmin"></div>
        </div>`;
    }
  } else {
    const mine = reports.filter(r=>r.matricula===currentUser.matricula).sort(byDateDesc);
    const top15 = mine.slice(0,15);
    const rest = mine.slice(15);
    content += `<div class="card">
        <h3>Meus relatórios</h3>
        ${renderReports(top15, false, false)}
        ${rest.length? `<hr/><details><summary>Relatórios antigos (minimizados)</summary>${renderReports(rest, false, true)}</details>` : ''}
      </div>`;
  }
  content += `</div>`;
  app.innerHTML = top + content;
}
console.log("DEBUG: Entrando na função function renderReports(");function renderReports(list, asAdmin, startMinimized=false){
  if(!list.length) return '<span class="small">Sem relatórios.</span>';
  return list.map(r=>{
    const i = reports.indexOf(r);
    const hasPos = r.posObs && ((r.posObs.text||"").trim().length>0 || (r.posObs.images||[]).length>0);
    return `<div class="report">
      <div class="head">
        <div class="meta"><strong>${r.data}</strong> — Matrícula: ${r.matricula} ${hasPos?'<span class="alert">Verificar pós conferência</span>':''}</div>
        <div class="actions">
          ${asAdmin? `<button onclick="deleteReport(${i})">Excluir</button>`:''}
          <button onclick="toggleReport(${i})">Ver/Esconder</button>
          <button onclick="openObsPopup(${i})">Pós conferência</button>
        </div>
      </div>
      <div id="report-${i}" class="${startMinimized?'hidden':''}">
        Folha: <span class="kbd">${brl(r.folha)}</span> &nbsp;|&nbsp;
        Dinheiro: <span class="kbd">${brl(r.dinheiro)}</span> &nbsp;|&nbsp;
        Sobra/Falta: <span class="kbd">${brl(r.sf)}</span><br/>
        Observação: ${r.obs||''}
      </div>
    </div>`;
  }).join('');
}
console.log("DEBUG: Entrando na função function filterOlderAdmin(");function filterOlderAdmin(){
  const date = document.getElementById('filterDateAdmin').value;
  if(!date){ document.getElementById('olderAdmin').innerHTML = '<span class="small">Escolha uma data.</span>'; return; }
  const older = reports.filter(r=>r.matricula===adminViewMatricula && r.data<=date)
                       .sort(byDateDesc).slice(20);
  document.getElementById('olderAdmin').innerHTML = renderReports(older, true, true);
}
console.log("DEBUG: Entrando na função function openAdminMat(");function openAdminMat(mat){ adminViewMatricula = mat; renderMain(); }

renderLogin();
console.log("DEBUG: script.js terminou de carregar");

</script>
</body>
</html>